import type { Request, Response } from "express";
import { z } from "zod";

import { getPresignedUploadUrl } from "../services/s3.service";
import { createVideoUpload, listVideoUploadsByAthlete, reviewVideoUpload } from "../services/video.service";
import { getGuardianAndAthlete } from "../services/user.service";

const presignSchema = z.object({
  key: z.string().min(1),
  contentType: z.string().min(1),
});

const createSchema = z.object({
  videoUrl: z.string().url(),
  notes: z.string().optional(),
});

const reviewSchema = z.object({
  uploadId: z.number().int().min(1),
  feedback: z.string().min(1),
});

export async function createUploadUrl(req: Request, res: Response) {
  const input = presignSchema.parse(req.body);
  const url = await getPresignedUploadUrl({ key: input.key, contentType: input.contentType });
  return res.status(200).json({ url });
}

export async function createVideo(req: Request, res: Response) {
  const input = createSchema.parse(req.body);
  const { athlete } = await getGuardianAndAthlete(req.user!.id);
  if (!athlete) {
    return res.status(400).json({ error: "Onboarding incomplete" });
  }
  const item = await createVideoUpload({
    athleteId: athlete.id,
    videoUrl: input.videoUrl,
    notes: input.notes,
  });
  return res.status(201).json({ item });
}

export async function listVideos(req: Request, res: Response) {
  const { athlete } = await getGuardianAndAthlete(req.user!.id);
  if (!athlete) {
    return res.status(200).json({ items: [] });
  }
  const items = await listVideoUploadsByAthlete(athlete.id);
  return res.status(200).json({ items });
}

export async function reviewVideo(req: Request, res: Response) {
  const input = reviewSchema.parse(req.body);
  const item = await reviewVideoUpload({ uploadId: input.uploadId, coachId: req.user!.id, feedback: input.feedback });
  if (!item) {
    return res.status(404).json({ error: "Not found" });
  }
  return res.status(200).json({ item });
}
