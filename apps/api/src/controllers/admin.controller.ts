import type { Request, Response } from "express";
import { z } from "zod";

import {
  addExerciseToSession,
  assignEnrollment,
  createExercise,
  createProgramTemplate,
  createSession,
  getAdminProfile,
  getDashboardMetrics,
  getUserOnboarding,
  listBookingsAdmin,
  listMessageThreadsAdmin,
  listThreadMessagesAdmin,
  sendMessageAdmin,
  listUsers,
  setUserBlocked,
  softDeleteUser,
  updateAdminPreferences,
  updateAdminProfile,
  updateAthleteProgramTier,
  getOnboardingConfig,
  updateOnboardingConfig,
} from "../services/admin.service";
import { ProgramType, sessionType } from "../db/schema";

const updateTierSchema = z.object({
  athleteId: z.number().int().min(1),
  programTier: z.enum(ProgramType.enumValues),
});

const assignSchema = z.object({
  athleteId: z.number().int().min(1),
  programType: z.enum(ProgramType.enumValues),
  programTemplateId: z.number().int().min(1).optional(),
});

const programSchema = z.object({
  name: z.string().min(1),
  type: z.enum(ProgramType.enumValues),
  description: z.string().optional(),
});

const exerciseSchema = z.object({
  name: z.string().min(1),
  cues: z.string().optional(),
  sets: z.number().int().optional(),
  reps: z.number().int().optional(),
  duration: z.number().int().optional(),
  restSeconds: z.number().int().optional(),
  notes: z.string().optional(),
  videoUrl: z.string().url().optional(),
});

const sessionSchema = z.object({
  programId: z.number().int().min(1),
  weekNumber: z.number().int().min(1),
  sessionNumber: z.number().int().min(1),
  type: z.enum(sessionType.enumValues),
});

const sessionExerciseSchema = z.object({
  sessionId: z.number().int().min(1),
  exerciseId: z.number().int().min(1),
  order: z.number().int().min(1),
  coachingNotes: z.string().optional(),
  progressionNotes: z.string().optional(),
  regressionNotes: z.string().optional(),
});

const adminProfileSchema = z.object({
  name: z.string().min(1),
  email: z.string().email(),
  profilePicture: z.string().optional().nullable(),
  title: z.string().optional().nullable(),
  bio: z.string().optional().nullable(),
});

const adminPreferencesSchema = z.object({
  timezone: z.string().min(1),
  notificationSummary: z.string().min(1),
  workStartHour: z.number().int().min(0).max(23),
  workStartMinute: z.number().int().min(0).max(59),
  workEndHour: z.number().int().min(0).max(23),
  workEndMinute: z.number().int().min(0).max(59),
});

const onboardingFieldSchema = z.object({
  id: z.string().min(1),
  label: z.string().min(1),
  type: z.enum(["text", "number", "dropdown"]),
  required: z.boolean(),
  visible: z.boolean(),
  options: z.array(z.string().min(1)).optional(),
  optionsByTeam: z.record(z.array(z.string().min(1))).optional(),
});

const onboardingConfigSchema = z.object({
  version: z.number().int().min(1),
  fields: z.array(onboardingFieldSchema).min(1),
  requiredDocuments: z.array(
    z.object({
      id: z.string().min(1),
      label: z.string().min(1),
      required: z.boolean(),
    })
  ),
  welcomeMessage: z.string().optional().nullable(),
  coachMessage: z.string().optional().nullable(),
  defaultProgramTier: z.enum(ProgramType.enumValues),
  approvalWorkflow: z.enum(["manual", "auto"]).default("manual"),
  notes: z.string().optional().nullable(),
});

export async function listAllUsers(_req: Request, res: Response) {
  const users = await listUsers();
  return res.status(200).json({ users });
}

export async function blockUser(req: Request, res: Response) {
  const userId = z.coerce.number().int().min(1).parse(req.params.userId);
  const body = z.object({ blocked: z.boolean() }).parse(req.body);
  const user = await setUserBlocked(userId, body.blocked);
  if (!user) {
    return res.status(404).json({ error: "User not found" });
  }
  return res.status(200).json({ user });
}

export async function deleteUser(req: Request, res: Response) {
  const userId = z.coerce.number().int().min(1).parse(req.params.userId);
  const user = await softDeleteUser(userId);
  if (!user) {
    return res.status(404).json({ error: "User not found" });
  }
  return res.status(200).json({ user });
}

export async function getOnboarding(req: Request, res: Response) {
  const userId = z.coerce.number().int().min(1).parse(req.params.userId);
  const data = await getUserOnboarding(userId);
  return res.status(200).json(data);
}

export async function getAdminProfileDetails(req: Request, res: Response) {
  const data = await getAdminProfile(req.user!.id);
  if (!data) {
    return res.status(404).json({ error: "Admin profile not found" });
  }
  return res.status(200).json(data);
}

export async function updateAdminProfileDetails(req: Request, res: Response) {
  const parsed = adminProfileSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: "Invalid request", details: parsed.error.flatten().fieldErrors });
  }
  const data = await updateAdminProfile(req.user!.id, parsed.data);
  return res.status(200).json(data);
}

export async function updateAdminPreferencesDetails(req: Request, res: Response) {
  const parsed = adminPreferencesSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: "Invalid request", details: parsed.error.flatten().fieldErrors });
  }
  const data = await updateAdminPreferences(req.user!.id, parsed.data);
  return res.status(200).json(data);
}

export async function getOnboardingConfigDetails(_req: Request, res: Response) {
  const data = await getOnboardingConfig();
  return res.status(200).json({ config: data });
}

export async function updateOnboardingConfigDetails(req: Request, res: Response) {
  const parsed = onboardingConfigSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: "Invalid request", details: parsed.error.flatten().fieldErrors });
  }
  const data = await updateOnboardingConfig(req.user!.id, parsed.data);
  return res.status(200).json({ config: data });
}

export async function updateProgramTier(req: Request, res: Response) {
  const input = updateTierSchema.parse(req.body);
  const athlete = await updateAthleteProgramTier(input.athleteId, input.programTier);
  return res.status(200).json({ athlete });
}

export async function assignProgram(req: Request, res: Response) {
  const input = assignSchema.parse(req.body);
  const enrollment = await assignEnrollment({
    athleteId: input.athleteId,
    programType: input.programType,
    programTemplateId: input.programTemplateId,
    assignedByCoach: req.user!.id,
  });
  return res.status(201).json({ enrollment });
}

export async function createProgram(req: Request, res: Response) {
  const input = programSchema.parse(req.body);
  const program = await createProgramTemplate({
    name: input.name,
    type: input.type,
    description: input.description,
    createdBy: req.user!.id,
  });
  return res.status(201).json({ program });
}

export async function createExerciseItem(req: Request, res: Response) {
  const input = exerciseSchema.parse(req.body);
  const exercise = await createExercise({
    name: input.name,
    cues: input.cues,
    sets: input.sets,
    reps: input.reps,
    duration: input.duration,
    restSeconds: input.restSeconds,
    notes: input.notes,
    videoUrl: input.videoUrl,
  });
  return res.status(201).json({ exercise });
}

export async function createSessionItem(req: Request, res: Response) {
  const input = sessionSchema.parse(req.body);
  const session = await createSession({
    programId: input.programId,
    weekNumber: input.weekNumber,
    sessionNumber: input.sessionNumber,
    type: input.type,
  });
  return res.status(201).json({ session });
}

export async function addExercise(req: Request, res: Response) {
  const input = sessionExerciseSchema.parse(req.body);
  const item = await addExerciseToSession({
    sessionId: input.sessionId,
    exerciseId: input.exerciseId,
    order: input.order,
    coachingNotes: input.coachingNotes,
    progressionNotes: input.progressionNotes,
    regressionNotes: input.regressionNotes,
  });
  return res.status(201).json({ item });
}

export async function listBookings(req: Request, res: Response) {
  const bookings = await listBookingsAdmin();
  return res.status(200).json({ bookings });
}

export async function listMessageThreads(req: Request, res: Response) {
  const threads = await listMessageThreadsAdmin(req.user!.id);
  return res.status(200).json({ threads });
}

export async function listThreadMessages(req: Request, res: Response) {
  const userId = z.coerce.number().int().min(1).parse(req.params.userId);
  const messages = await listThreadMessagesAdmin(req.user!.id, userId);
  return res.status(200).json({ messages });
}

export async function sendAdminMessage(req: Request, res: Response) {
  const userId = z.coerce.number().int().min(1).parse(req.params.userId);
  const body = z.object({ content: z.string().min(1) }).parse(req.body);
  const message = await sendMessageAdmin({ coachId: req.user!.id, userId, content: body.content });
  return res.status(201).json({ message });
}

export async function getDashboard(req: Request, res: Response) {
  const data = await getDashboardMetrics(req.user!.id);
  return res.status(200).json(data);
}
